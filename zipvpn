#!/bin/bash
# ZIVPN + ADMIN PANEL (ONE FILE) - "VPN MULTI PLUS"
# - Multi-admin login (DB accounts + hashed password)
# - Users page with Edit button (auto-fill form)
# - Trial menu (auto random user/pass + days)
# - Password lock by password ONLY (respected by Sync Now + Daily Sync)
# - Backup/Restore
set -euo pipefail
export DEBIAN_FRONTEND=noninteractive

ZIVPN_BIN="/usr/local/bin/zivpn"
ZIVPN_DIR="/etc/zivpn"
ZIVPN_CFG="${ZIVPN_DIR}/config.json"
ZIVPN_SVC="zivpn.service"

ADMIN_DIR="/opt/zivpn-admin"
APP_PY="${ADMIN_DIR}/app.py"
SYNC_PY="${ADMIN_DIR}/sync.py"
VENV="${ADMIN_DIR}/venv"
ENV_FILE="${ADMIN_DIR}/.env"

PANEL_SVC="zivpn-admin.service"
SYNC_SVC="zivpn-sync.service"
SYNC_TIMER="zivpn-sync.timer"

echo "==> Update packages..."
apt-get update -y && apt-get upgrade -y

echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections || true
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections || true

apt-get install -y python3-venv python3-pip openssl ufw curl jq wget iptables-persistent sqlite3 > /dev/null

echo "==> Install ZIVPN..."
systemctl stop ${ZIVPN_SVC} 2>/dev/null || true
wget -q https://github.com/zahidbd2/udp-zivpn/releases/download/udp-zivpn_1.4.9/udp-zivpn-linux-amd64 -O "${ZIVPN_BIN}"
chmod +x "${ZIVPN_BIN}"

mkdir -p "${ZIVPN_DIR}"
cat > "${ZIVPN_CFG}" <<'JSON'
{
  "listen": ":1433",
  "cert": "/etc/zivpn/zivpn.crt",
  "key": "/etc/zivpn/zivpn.key",
  "obfs": "zivpn",
  "auth": {"mode": "passwords", "config": ["zi"]},
  "config": ["zi"]
}
JSON

echo "==> Generate TLS cert..."
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
  -subj "/C=US/ST=CA/L=LA/O=ZIVPN/CN=zivpn" \
  -keyout "${ZIVPN_DIR}/zivpn.key" -out "${ZIVPN_DIR}/zivpn.crt" >/dev/null 2>&1

cat >/etc/systemd/system/${ZIVPN_SVC} <<'EOF'
[Unit]
Description=ZIVPN UDP Server
After=network.target

[Service]
ExecStart=/usr/local/bin/zivpn server -c /etc/zivpn/config.json
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now ${ZIVPN_SVC}

IFC=$(ip -4 route ls | awk '/default/ {print $5; exit}')
echo "==> NAT REDIRECT UDP 6000-19999 -> 1433..."
if [[ -n "${IFC}" ]]; then
  iptables -t nat -C PREROUTING -i "$IFC" -p udp --dport 6000:19999 -j REDIRECT --to-ports 1433 2>/dev/null \
    || iptables -t nat -A PREROUTING -i "$IFC" -p udp --dport 6000:19999 -j REDIRECT --to-ports 1433
else
  iptables -t nat -C PREROUTING -p udp --dport 6000:19999 -j REDIRECT --to-ports 1433 2>/dev/null \
    || iptables -t nat -A PREROUTING -p udp --dport 6000:19999 -j REDIRECT --to-ports 1433
fi
netfilter-persistent save >/dev/null 2>&1 || true

SSH_PORT="$(ss -tlpn 2>/dev/null | awk '/sshd/ {gsub(/.*:/,"",$4); print $4; exit}')"
SSH_PORT="${SSH_PORT:-22}"
ufw allow ${SSH_PORT}/tcp || true
ufw allow OpenSSH || true
ufw allow 1433/udp || true

read -rp "Panel name [default: VPN MULTI PLUS]: " PANEL_NAME
PANEL_NAME=${PANEL_NAME:-"VPN MULTI PLUS"}

read -rp "Panel port [default: 8088]: " PANEL_PORT
PANEL_PORT=${PANEL_PORT:-8088}
ufw allow ${PANEL_PORT}/tcp || true
ufw --force enable || true

read -rp "Bandwidth interface (eth0/ens3) [default: auto]: " BW_IFACE
BW_IFACE=${BW_IFACE:-}

read -rp "Create FIRST admin username [default: admin]: " FIRST_ADMIN
FIRST_ADMIN=${FIRST_ADMIN:-admin}
read -rp "Create FIRST admin password [default: change-me]: " FIRST_PASS
FIRST_PASS=${FIRST_PASS:-change-me}

echo "==> Setup Panel..."
mkdir -p "${ADMIN_DIR}"
python3 -m venv "${VENV}"
"${VENV}/bin/pip" install flask waitress werkzeug >/dev/null

SECRET_KEY=$(openssl rand -hex 32)
cat > "${ENV_FILE}" <<EOF
PANEL_NAME=${PANEL_NAME}
SECRET_KEY=${SECRET_KEY}
BIND_HOST=0.0.0.0
BIND_PORT=${PANEL_PORT}
ZIVPN_CONFIG=${ZIVPN_CFG}
ZIVPN_SERVICE=${ZIVPN_SVC}
BW_IFACE=${BW_IFACE}
FIRST_ADMIN=${FIRST_ADMIN}
FIRST_PASS=${FIRST_PASS}
EOF
chmod 600 "${ENV_FILE}"

mkdir -p /var/lib/zivpn-admin
chmod 700 /var/lib/zivpn-admin

cat > "${APP_PY}" <<'PY'
#!/usr/bin/env python3
import os, json, sqlite3, tempfile, subprocess, time, io, tarfile, shutil, random, string
from subprocess import DEVNULL
from datetime import date, datetime, timedelta
from functools import wraps
from flask import Flask, request, redirect, url_for, session, render_template_string, flash, jsonify, send_file
from werkzeug.security import generate_password_hash, check_password_hash

DB="/var/lib/zivpn-admin/zivpn.db"
os.makedirs("/var/lib/zivpn-admin", exist_ok=True)

PANEL_NAME=os.getenv("PANEL_NAME","VPN MULTI PLUS")
ZIVPN_CFG=os.getenv("ZIVPN_CONFIG","/etc/zivpn/config.json")
ZIVPN_SVC=os.getenv("ZIVPN_SERVICE","zivpn.service")
BW_IFACE=os.getenv("BW_IFACE","").strip()

FIRST_ADMIN=os.getenv("FIRST_ADMIN","admin")
FIRST_PASS=os.getenv("FIRST_PASS","change-me")

app=Flask(__name__)
app.secret_key=os.getenv("SECRET_KEY","change-this-secret")
app.permanent_session_lifetime = timedelta(hours=10)

_bw_prev={}

def db():
    con=sqlite3.connect(DB)
    con.row_factory=sqlite3.Row
    return con

def now_s():
    return datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")

def init_db():
    with db() as con:
        con.execute("""CREATE TABLE IF NOT EXISTS accounts(
            id INTEGER PRIMARY KEY,
            username TEXT UNIQUE,
            password_hash TEXT NOT NULL,
            is_active INTEGER NOT NULL DEFAULT 1,
            created_at TEXT NOT NULL
        )""")
        con.execute("""CREATE TABLE IF NOT EXISTS users(
            id INTEGER PRIMARY KEY,
            username TEXT UNIQUE,
            password TEXT,
            expires DATE
        )""")
        con.execute("""CREATE TABLE IF NOT EXISTS pw_state(
            password TEXT PRIMARY KEY,
            locked INTEGER DEFAULT 0
        )""")
    # seed first admin
    with db() as con:
        r=con.execute("SELECT id FROM accounts WHERE username=?",(FIRST_ADMIN,)).fetchone()
        if not r:
            con.execute("INSERT INTO accounts(username,password_hash,is_active,created_at) VALUES(?,?,1,?)",
                        (FIRST_ADMIN, generate_password_hash(FIRST_PASS), now_s()))

init_db()

def login_required(f):
    @wraps(f)
    def w(*a,**kw):
        if not session.get("ok"):
            return redirect(url_for("login"))
        return f(*a,**kw)
    return w

def admin_required(f):
    @wraps(f)
    def w(*a,**kw):
        if not session.get("ok"):
            return redirect(url_for("login"))
        return f(*a,**kw)
    return w

def me():
    uid=session.get("uid")
    if not uid: return None
    with db() as con:
        return con.execute("SELECT id,username,is_active,created_at FROM accounts WHERE id=?",(uid,)).fetchone()

# ---------- Password lock ONLY (FIX) ----------
def set_pw_lock(pw:str, locked:int):
    locked=1 if locked else 0
    with db() as con:
        con.execute("""INSERT INTO pw_state(password,locked) VALUES(?,?)
                       ON CONFLICT(password) DO UPDATE SET locked=?""",(pw,locked,locked))

def password_rows():
    with db() as con:
        rows=con.execute("""
            SELECT u.password AS password, COUNT(*) AS cnt,
                   COALESCE(s.locked,0) AS locked,
                   MIN(u.expires) AS min_exp, MAX(u.expires) AS max_exp
            FROM users u
            LEFT JOIN pw_state s ON s.password=u.password
            GROUP BY u.password
            ORDER BY locked DESC, cnt DESC, u.password ASC
        """).fetchall()
    return rows

def sync():
    # IMPORTANT: excludes locked passwords
    with db() as con:
        pw=[r[0] for r in con.execute("""
            SELECT DISTINCT u.password
            FROM users u
            LEFT JOIN pw_state s ON s.password=u.password
            WHERE DATE(u.expires) >= DATE('now')
              AND COALESCE(s.locked, 0)=0
        """)]
    if not pw:
        pw=["zi"]
    cfg={}
    try:
        cfg=json.load(open(ZIVPN_CFG))
    except Exception:
        pass
    cfg.setdefault("auth",{})["mode"]="passwords"
    cfg["auth"]["config"]=pw
    cfg["config"]=pw
    with tempfile.NamedTemporaryFile("w",delete=False) as f:
        json.dump(cfg,f,indent=2); tmp=f.name
    os.replace(tmp,ZIVPN_CFG)
    subprocess.Popen(["systemctl","restart",ZIVPN_SVC], stdout=DEVNULL, stderr=DEVNULL)

# ---------- BW ----------
def _default_iface():
    try:
        out=subprocess.check_output(["ip","-4","route","ls"]).decode()
        for line in out.splitlines():
            if line.startswith("default "):
                return line.split()[4]
    except Exception:
        pass
    return "eth0"

def _read_proc_net_dev():
    data={}
    try:
        with open("/proc/net/dev","r",encoding="utf-8",errors="ignore") as f:
            lines=f.read().splitlines()
        for ln in lines[2:]:
            if ":" not in ln: continue
            iface, rest = ln.split(":",1)
            iface=iface.strip()
            parts=rest.split()
            if len(parts) < 16: continue
            rx=int(parts[0]); tx=int(parts[8])
            data[iface]=(rx,tx)
    except Exception:
        return {}
    return data

def _human_best(n:int)->str:
    n=float(max(0,n))
    gb=n/(1024**3)
    if gb>=1: return f"{gb:.2f} GB"
    mb=n/(1024**2)
    if mb>=1: return f"{mb:.2f} MB"
    kb=n/1024
    return f"{kb:.2f} KB"

def get_bw_snapshot():
    iface=BW_IFACE or _default_iface()
    dev=_read_proc_net_dev()
    if iface not in dev:
        for k in dev.keys():
            if k!="lo":
                iface=k; break
    now=time.time()
    rx,tx=dev.get(iface,(0,0))
    prev=_bw_prev.get(iface)
    rx_mbps=tx_mbps=0.0
    if prev:
        pts, prx, ptx = prev
        dt=max(0.001, now-pts)
        rx_mbps=((rx-prx)*8.0)/dt/1_000_000.0
        tx_mbps=((tx-ptx)*8.0)/dt/1_000_000.0
    _bw_prev[iface]=(now,rx,tx)
    return {"iface":iface,"rx_mbps":round(max(0.0,rx_mbps),2),"tx_mbps":round(max(0.0,tx_mbps),2),
            "rx_total_h":_human_best(rx),"tx_total_h":_human_best(tx)}

@app.route("/api/bw")
@login_required
def api_bw():
    return jsonify(get_bw_snapshot())

# ---------- Login ----------
@app.route("/login", methods=["GET","POST"])
def login():
    if request.method=="POST":
        u=request.form.get("u","").strip()
        p=request.form.get("p","").strip()
        with db() as con:
            r=con.execute("SELECT id,username,password_hash,is_active FROM accounts WHERE username=?",(u,)).fetchone()
        if r and int(r["is_active"])==1 and check_password_hash(r["password_hash"], p):
            session.clear()
            session.permanent=True
            session["ok"]=True
            session["uid"]=int(r["id"])
            return redirect("/")
        flash("Login gagal")
    return render_template_string(TPL_LOGIN, panel_name=PANEL_NAME)

@app.route("/logout")
def logout():
    session.clear()
    return redirect("/login")

# ---------- Users list page + Edit button ----------
@app.route("/users")
@admin_required
def users_page():
    with db() as con:
        rows=con.execute("""
            SELECT username,password,expires
            FROM users
            ORDER BY DATE(expires) DESC, id DESC
            LIMIT 300
        """).fetchall()
    return render_template_string(TPL_USERS, panel_name=PANEL_NAME, me=me(), rows=rows)

@app.route("/api/user/<username>")
@admin_required
def api_user(username):
    with db() as con:
        r=con.execute("SELECT username,password,expires FROM users WHERE username=?",(username,)).fetchone()
    if not r:
        return jsonify({"ok":False})
    return jsonify({"ok":True,"username":r["username"],"password":r["password"],"expires":r["expires"]})

# ---------- Trial ----------
def _rand(n=6):
    return ''.join(random.choice(string.ascii_lowercase+string.digits) for _ in range(n))

@app.route("/trial", methods=["GET","POST"])
@admin_required
def trial():
    if request.method=="POST":
        days=int(request.form.get("days","1") or 1)
        prefix=(request.form.get("prefix","trial").strip() or "trial")
        username=f"{prefix}{_rand(6)}"
        password=f"{prefix}{_rand(6)}"
        exp=(date.today()+timedelta(days=days)).isoformat()
        with db() as con:
            con.execute("INSERT INTO users(username,password,expires) VALUES(?,?,?)",(username,password,exp))
            con.execute("INSERT OR IGNORE INTO pw_state(password,locked) VALUES(?,0)",(password,))
        sync()
        flash(f"TRIAL dibuat: {username} / {password} exp={exp}")
        return redirect("/trial")

    with db() as con:
        rows=con.execute("""
          SELECT username,password,expires
          FROM users
          WHERE username LIKE 'trial%' OR username LIKE 'TRIAL%' OR username LIKE 'trial_%'
          ORDER BY id DESC LIMIT 100
        """).fetchall()
    return render_template_string(TPL_TRIAL, panel_name=PANEL_NAME, me=me(), rows=rows)

# ---------- Dashboard ----------
@app.route("/")
@admin_required
def index():
    edit_user=request.args.get("edit","").strip()
    edit_data=None
    if edit_user:
        with db() as con:
            r=con.execute("SELECT username,password,expires FROM users WHERE username=?",(edit_user,)).fetchone()
        if r:
            edit_data={"username":r["username"],"password":r["password"],"expires":r["expires"]}

    with db() as con:
        total_users=con.execute("SELECT COUNT(*) FROM users").fetchone()[0]
        total_active=con.execute("""
            SELECT COUNT(*)
            FROM users u
            LEFT JOIN pw_state s ON s.password=u.password
            WHERE DATE(u.expires) >= DATE('now')
              AND COALESCE(s.locked,0)=0
        """).fetchone()[0]

    pwrows=password_rows()
    try:
        vps_ip=subprocess.check_output(["hostname","-I"]).decode().split()[0]
    except Exception:
        vps_ip=request.host.split(":")[0]
    server_ts=int(time.time())
    default_exp=date.today().isoformat()

    return render_template_string(
        TPL_INDEX,
        panel_name=PANEL_NAME,
        me=me(),
        vps_ip=vps_ip,
        server_ts=server_ts,
        total_users=total_users,
        total_active=total_active,
        default_exp=default_exp,
        pwrows=pwrows,
        edit_data=edit_data
    )

@app.route("/save", methods=["POST"])
@admin_required
def save():
    u=request.form.get("username","").strip()
    p=request.form.get("password","").strip()
    e=request.form.get("expires","").strip()
    if not u or not p or not e:
        flash("Isi semua field"); return redirect("/")
    with db() as con:
        con.execute("""INSERT INTO users(username,password,expires)
                       VALUES(?,?,?)
                       ON CONFLICT(username) DO UPDATE SET password=?, expires=?""",(u,p,e,p,e))
        con.execute("INSERT OR IGNORE INTO pw_state(password,locked) VALUES(?,0)",(p,))
    sync()
    flash("User tersimpan & Sync OK (restart service)")
    return redirect("/")

@app.route("/syncnow", methods=["POST"])
@admin_required
def syncnow():
    sync()
    flash("Sync Now OK ✅ (restart service)")
    return redirect(request.referrer or "/")

@app.route("/lockpw", methods=["POST"])
@admin_required
def lockpw():
    pw=request.form.get("pw","")
    if not pw:
        flash("Password kosong"); return redirect("/")
    set_pw_lock(pw,1)
    flash(f"LOCKED: {pw}\nKlik Sync Now untuk apply.")
    return redirect(request.referrer or "/")

@app.route("/unlockpw", methods=["POST"])
@admin_required
def unlockpw():
    pw=request.form.get("pw","")
    if not pw:
        flash("Password kosong"); return redirect("/")
    set_pw_lock(pw,0)
    flash(f"UNLOCKED: {pw}\nKlik Sync Now untuk apply.")
    return redirect(request.referrer or "/")

# ---------- Admins (multi login) ----------
@app.route("/admins")
@admin_required
def admins():
    with db() as con:
        rows=con.execute("SELECT id,username,is_active,created_at FROM accounts ORDER BY id DESC").fetchall()
    return render_template_string(TPL_ADMINS, panel_name=PANEL_NAME, me=me(), rows=rows)

@app.route("/admin/create", methods=["POST"])
@admin_required
def admin_create():
    u=request.form.get("username","").strip()
    p=request.form.get("password","").strip()
    if not u or not p:
        flash("Isi username & password"); return redirect("/admins")
    with db() as con:
        try:
            con.execute("INSERT INTO accounts(username,password_hash,is_active,created_at) VALUES(?,?,1,?)",
                        (u, generate_password_hash(p), now_s()))
        except Exception as e:
            flash(f"Gagal: {e}"); return redirect("/admins")
    flash("Admin dibuat")
    return redirect("/admins")

@app.route("/admin/toggle", methods=["POST"])
@admin_required
def admin_toggle():
    aid=int(request.form.get("id","0") or 0)
    if not aid:
        return redirect("/admins")
    # jangan disable diri sendiri
    if aid == int(session.get("uid") or 0):
        flash("Tidak bisa disable akun sendiri"); return redirect("/admins")
    with db() as con:
        r=con.execute("SELECT is_active FROM accounts WHERE id=?",(aid,)).fetchone()
        if not r:
            flash("Not found"); return redirect("/admins")
        newv=0 if int(r["is_active"])==1 else 1
        con.execute("UPDATE accounts SET is_active=? WHERE id=?",(newv,aid))
    flash("Updated")
    return redirect("/admins")

@app.route("/admin/delete", methods=["POST"])
@admin_required
def admin_delete():
    aid=int(request.form.get("id","0") or 0)
    if not aid:
        return redirect("/admins")
    if aid == int(session.get("uid") or 0):
        flash("Tidak bisa hapus akun sendiri"); return redirect("/admins")
    with db() as con:
        con.execute("DELETE FROM accounts WHERE id=?",(aid,))
    flash("Admin deleted")
    return redirect("/admins")

# ---------- Backup/Restore ----------
def _tar_add_safe(tar: tarfile.TarFile, path: str, arcname: str):
    try:
        if os.path.exists(path):
            tar.add(path, arcname=arcname, recursive=True)
    except Exception:
        pass

@app.route("/backup")
@admin_required
def backup():
    ts=datetime.now().strftime("%Y%m%d-%H%M%S")
    fname=f"zivpn-backup-{ts}.tar.gz"
    buf=io.BytesIO()
    with tarfile.open(fileobj=buf, mode="w:gz") as tar:
        _tar_add_safe(tar,"/etc/zivpn","etc/zivpn")
        _tar_add_safe(tar,"/var/lib/zivpn-admin","var/lib/zivpn-admin")
    buf.seek(0)
    return send_file(buf, mimetype="application/gzip", as_attachment=True, download_name=fname)

@app.route("/restore", methods=["GET","POST"])
@admin_required
def restore():
    if request.method=="GET":
        return render_template_string(TPL_RESTORE, panel_name=PANEL_NAME, me=me())
    f=request.files.get("file")
    if not f:
        flash("No file"); return redirect("/")
    tmpdir=tempfile.mkdtemp(prefix="zivpn-restore-")
    try:
        tar=tarfile.open(fileobj=f.stream, mode="r:gz")
        tar.extractall(tmpdir)
        tar.close()
        if request.form.get("restore_db"):
            src=os.path.join(tmpdir,"var/lib/zivpn-admin")
            if os.path.exists(src):
                shutil.rmtree("/var/lib/zivpn-admin", ignore_errors=True)
                shutil.copytree(src,"/var/lib/zivpn-admin")
        if request.form.get("restore_cfg"):
            src=os.path.join(tmpdir,"etc/zivpn")
            if os.path.exists(src):
                shutil.rmtree("/etc/zivpn", ignore_errors=True)
                shutil.copytree(src,"/etc/zivpn")
        subprocess.call(["systemctl","restart","zivpn.service"])
        subprocess.call(["systemctl","restart","zivpn-admin.service"])
        flash("Restore SUCCESS ✔️")
    except Exception as e:
        flash(f"Restore FAILED: {e}")
    finally:
        shutil.rmtree(tmpdir, ignore_errors=True)
    return redirect("/")

# ---------- UI Templates ----------
BASE_CSS = """
<script src="https://cdn.tailwindcss.com"></script>
<style>
.glass{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);box-shadow:0 18px 70px rgba(0,0,0,.60)}
.soft{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
.muted{color:rgba(226,232,240,.72)}
</style>
"""

def NAV(me):
    return f"""
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-xl font-extrabold">{PANEL_NAME}</div>
        <div class="text-xs muted">Login as <b>{me['username']}</b></div>
      </div>
      <div class="flex gap-2 flex-wrap">
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600" href="/">Dashboard</a>
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600" href="/users">Users</a>
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-amber-500 hover:bg-amber-400" href="/trial">Trial</a>
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600" href="/admins">Admins</a>
        <form method="post" action="/syncnow">
          <button class="px-3 py-2 rounded-xl text-sm font-semibold bg-sky-600 hover:bg-sky-500">Sync Now</button>
        </form>
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600" href="/backup">Backup</a>
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600" href="/restore">Restore</a>
        <a class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600" href="/logout">Logout</a>
      </div>
    </div>
    """

TPL_LOGIN = f"""<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Login</title>{BASE_CSS}</head>
<body class="min-h-screen grid place-items-center bg-gradient-to-br from-[#050914] via-[#071021] to-[#04060f] text-white">
<div class="w-[360px] glass p-6 rounded-2xl">
  <div class="text-2xl font-extrabold mb-4">{{{{panel_name}}}}</div>
  {{% with msgs = get_flashed_messages() %}}{{% if msgs %}}
    <div class="mb-3 text-sm text-rose-200">{{{{ msgs[0] }}}}</div>
  {{% endif %}}{{% endwith %}}
  <form method="post" class="space-y-3">
    <input name="u" class="w-full p-3 rounded-xl bg-black/30 border border-white/10 outline-none" placeholder="Username">
    <input name="p" type="password" class="w-full p-3 rounded-xl bg-black/30 border border-white/10 outline-none" placeholder="Password">
    <button class="w-full bg-gradient-to-r from-emerald-500 to-sky-500 py-3 rounded-xl text-lg font-semibold">Login</button>
  </form>
</div></body></html>"""

TPL_INDEX = f"""<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>{PANEL_NAME}</title>{BASE_CSS}
<script>
async function refreshBW(){{
  try{{
    const r=await fetch('/api/bw',{{cache:'no-store'}});
    const j=await r.json();
    document.getElementById('bw-iface').textContent=j.iface??'auto';
    document.getElementById('bw-rx').textContent=(j.rx_mbps??0).toFixed(2);
    document.getElementById('bw-tx').textContent=(j.tx_mbps??0).toFixed(2);
    document.getElementById('bw-rx-total').textContent=j.rx_total_h??'-';
    document.getElementById('bw-tx-total').textContent=j.tx_total_h??'-';
  }}catch(e){{}}
}}
setInterval(refreshBW,1200); window.addEventListener('load',refreshBW);
</script>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#050914] via-[#071021] to-[#04060f] text-slate-100">
<div class="max-w-5xl mx-auto px-4 py-4">
  <div class="glass rounded-2xl p-4">{{{{ nav_html|safe }}}}</div>

  {{% with msgs = get_flashed_messages() %}}{{% if msgs %}}
    <div class="glass rounded-2xl p-4 mt-4 text-sm whitespace-pre-wrap">{{{{ msgs[0] }}}}</div>
  {{% endif %}}{{% endwith %}}

  <div class="grid md:grid-cols-2 gap-4 mt-4">
    <div class="glass rounded-2xl p-5">
      <div class="text-base font-semibold">VPS IP: <span class="font-bold">{{{{ vps_ip }}}}</span></div>
      <div class="mt-4 soft rounded-2xl p-4">
        <div class="text-lg font-extrabold mb-2">Bandwidth (<span id="bw-iface">auto</span>)</div>
        <div class="space-y-1 text-sm">
          <div class="flex justify-between"><span class="muted">Download</span><span><b><span id="bw-rx">0.00</span></b> Mbps</span></div>
          <div class="flex justify-between"><span class="muted">Upload</span><span><b><span id="bw-tx">0.00</span></b> Mbps</span></div>
          <div class="flex justify-between"><span class="muted">Total</span><span><b><span id="bw-rx-total">-</span></b> / <b><span id="bw-tx-total">-</span></b></span></div>
        </div>
      </div>
    </div>
    <div class="space-y-4">
      <div class="glass rounded-2xl p-4">
        <div class="muted text-sm">Total Users</div>
        <div class="mt-1 text-4xl font-extrabold">{{{{ total_users }}}}</div>
      </div>
      <div class="glass rounded-2xl p-4">
        <div class="muted text-sm">Active (not expired & not locked)</div>
        <div class="mt-1 text-4xl font-extrabold text-emerald-400">{{{{ total_active }}}}</div>
      </div>
    </div>
  </div>

  <div class="glass rounded-2xl p-4 mt-4">
    <div class="font-semibold text-lg mb-3">Add / Update User</div>
    <form method="post" action="/save" class="grid md:grid-cols-3 gap-2">
      <input name="username" placeholder="Username"
        value="{{{{ edit_data.username if edit_data else '' }}}}"
        class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none">
      <input name="password" placeholder="Password"
        value="{{{{ edit_data.password if edit_data else '' }}}}"
        class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none">
      <input type="date" name="expires"
        value="{{{{ edit_data.expires if edit_data else default_exp }}}}"
        class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none">
      <button class="md:col-span-3 rounded-xl py-3 font-semibold bg-gradient-to-r from-emerald-500 to-sky-500">Save & Sync</button>
    </form>
    <div class="mt-2 text-xs muted">Edit cepat: buka menu Users → klik Edit.</div>
  </div>

  <div class="glass rounded-2xl p-4 mt-4">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold text-lg">Password Lock Manager (by password)</div>
      <form method="post" action="/syncnow"><button class="px-3 py-2 rounded-xl text-sm font-semibold bg-sky-600 hover:bg-sky-500">Sync Now</button></form>
    </div>
    <div class="space-y-2">
      {{% for x in pwrows %}}
        <div class="soft rounded-xl p-3 flex items-center justify-between gap-3">
          <div>
            <div class="flex items-center gap-2 flex-wrap">
              <code class="px-2 py-1 rounded-lg bg-black/30 border border-white/10 text-sm">{{{{ x['password'] }}}}</code>
              {{% if x['locked'] %}}
                <span class="text-[11px] px-2 py-1 rounded-full bg-rose-500/15 text-rose-200 border border-rose-500/20">LOCKED</span>
              {{% else %}}
                <span class="text-[11px] px-2 py-1 rounded-full bg-emerald-500/15 text-emerald-200 border border-emerald-500/20">ACTIVE</span>
              {{% endif %}}
              <span class="text-[11px] muted">Users: {{{{ x['cnt'] }}}}</span>
            </div>
            <div class="text-[11px] muted mt-1">Exp range: {{{{ x['min_exp'] }}}} → {{{{ x['max_exp'] }}}}</div>
          </div>
          <div class="flex gap-2">
            {{% if x['locked'] %}}
              <form method="post" action="/unlockpw">
                <input type="hidden" name="pw" value="{{{{x['password']}}}}">
                <button class="px-3 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-emerald-500 to-sky-500">Unlock</button>
              </form>
            {{% else %}}
              <form method="post" action="/lockpw" onsubmit="return confirm('Lock password?');">
                <input type="hidden" name="pw" value="{{{{x['password']}}}}">
                <button class="px-3 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-rose-500 to-rose-700">Lock</button>
              </form>
            {{% endif %}}
          </div>
        </div>
      {{% endfor %}}
    </div>
  </div>
</div></body></html>"""

TPL_USERS = f"""<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Users</title>{BASE_CSS}
<script>
async function editUser(username){{
  const r=await fetch('/api/user/'+encodeURIComponent(username),{{cache:'no-store'}});
  const j=await r.json();
  if(!j.ok){{ alert('User not found'); return; }}
  const url=new URL(window.location.origin+'/');
  url.searchParams.set('edit', j.username);
  window.location.href=url.toString();
}}
</script>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#050914] via-[#071021] to-[#04060f] text-slate-100">
<div class="max-w-5xl mx-auto px-4 py-4">
  <div class="glass rounded-2xl p-4">{{{{ nav_html|safe }}}}</div>
  <div class="glass rounded-2xl p-4 mt-4 overflow-x-auto">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold text-lg">Users (max 300)</div>
      <div class="text-xs muted">Klik Edit → form di Dashboard terisi</div>
    </div>
    <table class="w-full text-sm">
      <thead class="muted"><tr><th class="text-left py-2">Username</th><th class="text-left py-2">Password</th><th class="text-left py-2">Expires</th><th class="text-left py-2">Action</th></tr></thead>
      <tbody>
      {{% for r in rows %}}
        <tr class="border-t border-white/10">
          <td class="py-2 font-semibold">{{{{ r['username'] }}}}</td>
          <td class="py-2"><code class="px-2 py-1 rounded-lg bg-black/30 border border-white/10">{{{{ r['password'] }}}}</code></td>
          <td class="py-2">{{{{ r['expires'] }}}}</td>
          <td class="py-2">
            <button onclick="editUser('{{{{ r['username'] }}}}')" class="px-3 py-2 rounded-xl text-sm font-semibold bg-sky-600 hover:bg-sky-500">Edit</button>
          </td>
        </tr>
      {{% endfor %}}
      </tbody>
    </table>
  </div>
</div></body></html>"""

TPL_TRIAL = f"""<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trial</title>{BASE_CSS}</head>
<body class="min-h-screen bg-gradient-to-br from-[#050914] via-[#071021] to-[#04060f] text-slate-100">
<div class="max-w-5xl mx-auto px-4 py-4">
  <div class="glass rounded-2xl p-4">{{{{ nav_html|safe }}}}</div>

  {{% with msgs = get_flashed_messages() %}}{{% if msgs %}}
    <div class="glass rounded-2xl p-4 mt-4 text-sm whitespace-pre-wrap">{{{{ msgs[0] }}}}</div>
  {{% endif %}}{{% endwith %}}

  <div class="glass rounded-2xl p-4 mt-4">
    <div class="font-semibold text-lg mb-3">Create Trial</div>
    <form method="post" class="grid md:grid-cols-3 gap-2">
      <input name="prefix" value="trial" class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none" placeholder="prefix">
      <select name="days" class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none">
        <option value="1">1 day</option><option value="2">2 days</option><option value="3">3 days</option><option value="7">7 days</option>
      </select>
      <button class="rounded-xl py-3 font-semibold bg-gradient-to-r from-amber-500 to-sky-500">Create & Sync</button>
    </form>
  </div>

  <div class="glass rounded-2xl p-4 mt-4 overflow-x-auto">
    <div class="font-semibold text-lg mb-3">Latest Trial (max 100)</div>
    <table class="w-full text-sm">
      <thead class="muted"><tr><th class="text-left py-2">Username</th><th class="text-left py-2">Password</th><th class="text-left py-2">Expires</th></tr></thead>
      <tbody>
      {{% for r in rows %}}
        <tr class="border-t border-white/10">
          <td class="py-2 font-semibold">{{{{ r['username'] }}}}</td>
          <td class="py-2"><code class="px-2 py-1 rounded-lg bg-black/30 border border-white/10">{{{{ r['password'] }}}}</code></td>
          <td class="py-2">{{{{ r['expires'] }}}}</td>
        </tr>
      {{% endfor %}}
      </tbody>
    </table>
  </div>
</div></body></html>"""

TPL_ADMINS = f"""<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admins</title>{BASE_CSS}</head>
<body class="min-h-screen bg-gradient-to-br from-[#050914] via-[#071021] to-[#04060f] text-slate-100">
<div class="max-w-5xl mx-auto px-4 py-4">
  <div class="glass rounded-2xl p-4">{{{{ nav_html|safe }}}}</div>

  {{% with msgs = get_flashed_messages() %}}{{% if msgs %}}
    <div class="glass rounded-2xl p-4 mt-4 text-sm">{{{{ msgs[0] }}}}</div>
  {{% endif %}}{{% endwith %}}

  <div class="glass rounded-2xl p-4 mt-4">
    <div class="font-semibold text-lg mb-3">Create Admin</div>
    <form method="post" action="/admin/create" class="grid md:grid-cols-3 gap-2">
      <input name="username" placeholder="username" class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none">
      <input name="password" placeholder="password" class="rounded-xl p-3 bg-black/30 border border-white/10 outline-none">
      <button class="rounded-xl py-3 font-semibold bg-gradient-to-r from-emerald-500 to-sky-500">Create</button>
    </form>
    <div class="mt-2 text-xs muted">Multi admin login aktif. Tidak bisa disable/hapus akun sendiri.</div>
  </div>

  <div class="glass rounded-2xl p-4 mt-4 overflow-x-auto">
    <div class="font-semibold text-lg mb-3">Admins</div>
    <table class="w-full text-sm">
      <thead class="muted"><tr><th class="text-left py-2">ID</th><th class="text-left py-2">Username</th><th class="text-left py-2">Active</th><th class="text-left py-2">Created</th><th class="text-left py-2">Actions</th></tr></thead>
      <tbody>
      {{% for r in rows %}}
        <tr class="border-t border-white/10">
          <td class="py-2">{{{{ r['id'] }}}}</td>
          <td class="py-2 font-semibold">{{{{ r['username'] }}}}</td>
          <td class="py-2">{{% if r['is_active'] %}}✅{{% else %}}❌{{% endif %}}</td>
          <td class="py-2 muted">{{{{ r['created_at'] }}}}</td>
          <td class="py-2">
            <div class="flex gap-2 flex-wrap">
              <form method="post" action="/admin/toggle">
                <input type="hidden" name="id" value="{{{{ r['id'] }}}}">
                <button class="px-3 py-2 rounded-xl text-sm font-semibold bg-slate-700 hover:bg-slate-600">Toggle</button>
              </form>
              <form method="post" action="/admin/delete" onsubmit="return confirm('Delete admin?');">
                <input type="hidden" name="id" value="{{{{ r['id'] }}}}">
                <button class="px-3 py-2 rounded-xl text-sm font-semibold bg-rose-600 hover:bg-rose-500">Delete</button>
              </form>
            </div>
          </td>
        </tr>
      {{% endfor %}}
      </tbody>
    </table>
  </div>
</div></body></html>"""

TPL_RESTORE = f"""<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Restore</title>{BASE_CSS}</head>
<body class="min-h-screen bg-gradient-to-br from-[#050914] via-[#071021] to-[#04060f] text-slate-100">
<div class="max-w-xl mx-auto px-4 py-8">
  <div class="glass rounded-2xl p-6">
    <div class="text-xl font-extrabold mb-4">{PANEL_NAME} • Restore</div>
    <form method="post" enctype="multipart/form-data" class="space-y-3">
      <input type="file" name="file" required class="w-full text-sm bg-black/30 p-3 rounded-xl border border-white/10">
      <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="restore_db" checked> Restore Database</label>
      <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="restore_cfg" checked> Restore Config</label>
      <button class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-semibold">Restore Now</button>
      <a href="/" class="block text-center text-sm muted hover:underline">Back</a>
    </form>
  </div>
</div></body></html>"""

@app.context_processor
def inject_nav():
    m=me()
    if not m:
        return {}
    return {"nav_html": NAV(m)}

if __name__=="__main__":
    from waitress import serve
    serve(app, host=os.getenv("BIND_HOST","0.0.0.0"), port=int(os.getenv("BIND_PORT","8088")))
PY

cat > "${SYNC_PY}" <<'PY'
import os, json, sqlite3, tempfile, subprocess
from subprocess import DEVNULL

DB="/var/lib/zivpn-admin/zivpn.db"
CFG=os.getenv("ZIVPN_CONFIG","/etc/zivpn/config.json")
SVC=os.getenv("ZIVPN_SERVICE","zivpn.service")

def ensure_tables():
    os.makedirs("/var/lib/zivpn-admin", exist_ok=True)
    with sqlite3.connect(DB) as con:
        con.execute("""CREATE TABLE IF NOT EXISTS users(
            id INTEGER PRIMARY KEY,
            username TEXT UNIQUE,
            password TEXT,
            expires DATE
        )""")
        con.execute("""CREATE TABLE IF NOT EXISTS pw_state(
            password TEXT PRIMARY KEY,
            locked INTEGER DEFAULT 0
        )""")

def actives():
    ensure_tables()
    with sqlite3.connect(DB) as con:
        pw=[r[0] for r in con.execute("""
            SELECT DISTINCT u.password
            FROM users u
            LEFT JOIN pw_state s ON s.password=u.password
            WHERE DATE(u.expires) >= DATE('now')
              AND COALESCE(s.locked,0)=0
        """)]
    return pw or ["zi"]

cfg={}
try:
    cfg=json.load(open(CFG))
except Exception:
    pass

pw=actives()
cfg.setdefault("auth",{})["mode"]="passwords"
cfg["auth"]["config"]=pw
cfg["config"]=pw

with tempfile.NamedTemporaryFile("w",delete=False) as f:
    json.dump(cfg,f,indent=2); tmp=f.name
os.replace(tmp,CFG)
subprocess.Popen(["systemctl","restart",SVC], stdout=DEVNULL, stderr=DEVNULL)
PY

chmod +x "${APP_PY}" "${SYNC_PY}"

cat >/etc/systemd/system/${PANEL_SVC} <<EOF
[Unit]
Description=ZIVPN Admin Panel (Multi Admin)
After=network.target

[Service]
EnvironmentFile=${ENV_FILE}
WorkingDirectory=${ADMIN_DIR}
ExecStart=${VENV}/bin/python ${APP_PY}
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF

cat >/etc/systemd/system/${SYNC_SVC} <<EOF
[Unit]
Description=ZIVPN Daily Sync (respects password lock)

[Service]
EnvironmentFile=${ENV_FILE}
ExecStart=${VENV}/bin/python ${SYNC_PY}
EOF

cat >/etc/systemd/system/${SYNC_TIMER} <<'EOF'
[Unit]
Description=Run ZIVPN daily sync

[Timer]
OnCalendar=*-*-* 00:10:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

systemctl daemon-reload
systemctl enable --now ${PANEL_SVC}
systemctl enable --now ${SYNC_TIMER}

IP=$(hostname -I | awk '{print $1}')
echo
echo "✅ INSTALL COMPLETE"
echo "Panel: http://${IP}:${PANEL_PORT}/login"
echo "First Admin: ${FIRST_ADMIN}"
echo "Panel Name: ${PANEL_NAME}"
echo "======================================"
